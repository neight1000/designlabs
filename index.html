<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EQ Axis Flip + UI BPM/dB</title>
  <style>
    html, body { margin: 0; padding: 0; background: #000; color: #fff; font-family: sans-serif; height: 100vh; }
    #controls { position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); padding: 10px 20px; border-radius: 8px; z-index: 10; display: flex; gap: 1em; align-items: center; }
    .readout { min-width:70px; display:inline-block; text-align:right; font-family:monospace; }
    canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; display:block; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">Start</button>
    <span class="readout" id="dbReadout">dB: --</span>
    <span class="readout" id="bpmReadout">BPM: --</span>
  </div>
  <canvas id="vis"></canvas>
  <script>
    // DOM
    const vis = document.getElementById('vis');
    const ctx = vis.getContext('2d');
    const dbReadout = document.getElementById('dbReadout');
    const bpmReadout = document.getElementById('bpmReadout');
    let audioCtx, analyser, data, startTime=0, dbSmoothed=-60, beatTimes=[], bpm=0, lastBeat=0;

    function resize() {
      vis.width = window.innerWidth;
      vis.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function updateDbMeter(arr) {
      let sum=0; for(let i=0;i<arr.length;i++) sum+=arr[i]*arr[i];
      let rms=Math.sqrt(sum/arr.length);
      let db=20*Math.log10(rms||1e-8);
      dbSmoothed=dbSmoothed*0.85+db*0.15;
      dbReadout.textContent = "dB: " + (db>-60?db.toFixed(1):"--");
      return db;
    }

    function detectBpm(arr, time) {
      // Use bass bin for beat detection
      let bass = arr[2]/255;
      let threshold = 0.5, cooldown = 0.3;
      if (bass > threshold && time - lastBeat > cooldown) {
        lastBeat = time;
        beatTimes.push(time);
        if (beatTimes.length > 8) beatTimes.shift();
        if (beatTimes.length >= 2) {
          let intervals = [];
          for (let i=1;i<beatTimes.length;i++) intervals.push(beatTimes[i]-beatTimes[i-1]);
          let avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
          bpm = 60/avg;
        }
      }
      bpmReadout.textContent = "BPM: " + (bpm>0?Math.round(bpm):"--");
    }

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0,0,vis.width,vis.height);

      // BARS: vertical, grow top-to-bottom, X is frequency
      let bins=data.length, slice=vis.width/bins;
      for(let i=0;i<bins;i++) {
        let amp=data[i]/255, x=i*slice, h=amp*vis.height;
        ctx.fillStyle="#0ff";
        ctx.fillRect(x, 0, slice-1, h);
      }
      // Hz grid lines (vertical)
      let freqs=[60,250,1000,4000,16000], nyq=audioCtx.sampleRate/2;
      ctx.strokeStyle="#fff8"; ctx.font="12px monospace"; ctx.fillStyle="#fff8";
      freqs.forEach(f=>{
        let b=Math.round(f/nyq*bins), x=b*slice;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,vis.height); ctx.stroke();
        ctx.save(); ctx.translate(x+2, vis.height-10); ctx.rotate(-Math.PI/8); ctx.fillText(f+"Hz",0,0); ctx.restore();
      });

      // dB and BPM meters update in UI
      let db = updateDbMeter(data);
      let time = (performance.now()-startTime)/1000;
      detectBpm(data, time);
    }

    startBtn.onclick = async () => {
      if(audioCtx) return;
      vis.width=window.innerWidth; vis.height=window.innerHeight;
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser(); analyser.fftSize=512;
      data = new Uint8Array(analyser.frequencyBinCount);
      let stream = await navigator.mediaDevices.getUserMedia({audio:true});
      let src = audioCtx.createMediaStreamSource(stream);
      src.connect(analyser);
      startTime = performance.now();
      draw();
    };
  </script>
</body>
</html>

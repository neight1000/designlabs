<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plantasia App v3 – Sub-Oscillator & Phaser Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; background:black; color:white; font-family:monospace; overflow:hidden; }
    canvas { position:absolute; top:0; left:0; width:100vw; height:100vh; z-index:0; }
    .ui {
      position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.85);
      padding:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:10px; z-index:2;
    }
    .ui label { font-size:10px; display:block; text-align:center; }
    .ui select, .ui input[type="range"] {
      width:90px; background:black; color:white; border:1px solid white; font-size:10px;
    }
    .ui button {
      font-size:12px; padding:4px 8px; background:transparent; border:1px solid white; color:white; cursor:pointer;
    }
    #infoDisplay {
      position:absolute; top:10px; left:10px; z-index:3; background:rgba(0,0,0,0.6);
      color:white; font-size:12px; padding:10px; display:none; white-space:pre;
    }
  </style>
</head>
<body>
  <canvas id="waveCanvas"></canvas>
  <div id="infoDisplay"></div>
  <div class="ui">
    <div><label>Preset</label>
      <select id="preset">
        <option>Root Phonotropism</option>
        <option>Germination Kickstart</option>
        <option>Biomass Builder</option>
        <option>Hormonal Harmony</option>
        <option>Leaf Resonance</option>
        <option>Algal Bloom</option>
        <option>Leaf Growth Accelerator</option>
        <option>Nectar Boost</option>
        <option>Cereal Sprout</option>
        <option>Fruiting Uplift</option>
        <option>Buzz Pollination</option>
        <option>Alyssum Sprouter Surround</option>
      </select>
    </div>
    <div><label>Delay</label><input type="range" id="delay"   min="0.01" max="2.0" step="0.01" value="0.6" /></div>
    <div><label>Echo</label><input type="range" id="echo"    min="0"    max="1.0" step="0.01" value="0.4" /></div>
    <div><label>Filter</label><input type="range" id="filter"  min="100"  max="8000" step="10"   value="1200" /></div>
    <div><label>Sub Level</label><input type="range" id="subLevel" min="0"   max="0.2" step="0.01" value="0.08" /></div>
    <div><label>Vol</label><input type="range" id="volume" min="0"   max="100" step="1"    value="60" /></div>
    <div><label>BPM</label><input type="range" id="bpm"    min="40"  max="180" step="1"    value="90" /></div>
    <!-- Phaser controls added -->
    <div><label>Phaser Rate</label><input type="range" id="phaserRate"     min="0.1" max="5"   step="0.1" value="0.5"  /></div>
    <div><label>Phaser Feedback</label><input type="range" id="phaserFeedback" min="0"   max="0.8" step="0.05" value="0.4" /></div>
    <div><label>Phaser Stages</label><input type="range" id="phaserStages"   min="1"   max="8"   step="1"    value="4"   /></div>
    <button id="play">PLAY</button>
    <button id="stop">STOP</button>
    <button id="toggleDisplay">TOGGLE DATA</button>
  </div>

  <script>
    // Core Setup
    let audioCtx, analyser, masterGain, reverbNode, bufferLength, dataArray;
    let bpm=90, bpmTimer=null, stopped=true;
    let trailFrames=[], currentWaveColor="#00FF7F";
    let canvas, ctx;

    // Phaser nodes
    let phaserInput, phaserOutput, phaserFeedbackNode, phaserFilters=[], phaserLFO, phaserLFOGain;

    // Visual constants
    const VISUAL_FRAMES=12, VISUAL_ALPHA_BASE=0.05, VISUAL_ALPHA_MAX=0.2;

    // Human A-minor pentatonic
    const humanPentatonic=[220.00,261.63,293.66,329.63,392.00];

    // Preset Settings
    const presetSettings={
      "Root Phonotropism":         {scale:humanPentatonic, color:"#00FF7F"},
      "Germination Kickstart":     {scale:humanPentatonic, color:"#A0522D"},
      "Biomass Builder":           {scale:humanPentatonic, color:"#228B22"},
      "Hormonal Harmony":          {scale:humanPentatonic, color:"#FFD700"},
      "Leaf Resonance":            {scale:humanPentatonic, color:"#008000"},
      "Algal Bloom":               {scale:humanPentatonic, color:"#00FA9A"},
      "Leaf Growth Accelerator":   {scale:humanPentatonic, color:"#7CFC00"},
      "Nectar Boost":              {scale:humanPentatonic, color:"#FF69B4"},
      "Cereal Sprout":             {scale:humanPentatonic, color:"#F4A460"},
      "Fruiting Uplift":           {scale:humanPentatonic, color:"#FF4500"},
      "Buzz Pollination":          {scale:humanPentatonic, color:"#FFFF00"},
      "Alyssum Sprouter Surround": {scale:humanPentatonic, color:"#EE82EE"}
    };

    function getScaleFromPreset(v){ return presetSettings[v]?.scale||humanPentatonic; }
    function getColorFromPreset(v){ return presetSettings[v]?.color||"#FFFFFF"; }

    function initAudio(){
      if(audioCtx) return;
      canvas=document.getElementById("waveCanvas");
      ctx=canvas.getContext("2d");
      canvas.width=window.innerWidth; canvas.height=window.innerHeight;
      window.addEventListener("resize",()=>{
        canvas.width=window.innerWidth; canvas.height=window.innerHeight;
      });

      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      analyser=audioCtx.createAnalyser();
      analyser.fftSize=2048; bufferLength=analyser.frequencyBinCount;
      dataArray=new Uint8Array(bufferLength);

      masterGain=audioCtx.createGain();
      masterGain.gain.value=parseFloat(volume.value)/100;

      // Reverb
      reverbNode=audioCtx.createDelay();
      const rf=audioCtx.createGain();
      reverbNode.delayTime.value=0.3; rf.gain.value=0.3;
      reverbNode.connect(rf); rf.connect(reverbNode); reverbNode.connect(masterGain);

      // Chorus
      const chorus=audioCtx.createDelay(), depth=audioCtx.createGain();
      depth.gain.value=0.003;
      phaserLFO=audioCtx.createOscillator();
      phaserLFO.frequency.value=parseFloat(phaserRate.value);
      phaserLFOGain=audioCtx.createGain();
      phaserLFOGain.gain.value=400;
      phaserLFO.connect(phaserLFOGain);

      // Phaser chain
      const stages=parseInt(phaserStages.value);
      phaserInput=audioCtx.createGain(); phaserOutput=audioCtx.createGain();
      phaserFeedbackNode=audioCtx.createGain();
      phaserFeedbackNode.gain.value=parseFloat(phaserFeedback.value);
      let prev=phaserInput;
      for(let i=0;i<stages;i++){
        const ap=audioCtx.createBiquadFilter();
        ap.type="allpass"; ap.frequency.value=1000;
        prev.connect(ap); prev=ap; phaserFilters.push(ap);
        phaserLFOGain.connect(ap.frequency);
      }
      prev.connect(phaserOutput);
      phaserOutput.connect(phaserFeedbackNode).connect(phaserInput);
      phaserLFO.start();

      masterGain.connect(chorus);
      chorus.connect(audioCtx.destination);
      masterGain.connect(audioCtx.destination);

      animate();
    }

    function playTone(freq){
      const now=audioCtx.currentTime;
      const filterNode=audioCtx.createBiquadFilter();
      filterNode.type="lowpass";
      filterNode.frequency.value=Math.min(parseFloat(filter.value),5000);

      const delayNode=audioCtx.createDelay();
      delayNode.delayTime.value=parseFloat(delay.value);
      const fb=audioCtx.createGain();
      fb.gain.value=parseFloat(echo.value);

      const gainNode=audioCtx.createGain();
      gainNode.gain.setValueAtTime(0,now);
      gainNode.gain.linearRampToValueAtTime(0.18,now+0.2);
      gainNode.gain.setValueAtTime(0.18,now+1.5);
      gainNode.gain.linearRampToValueAtTime(0,now+4.0);

      const pan=audioCtx.createStereoPanner();
      pan.pan.value=0;

      [-0.2,0,0.2].forEach(off=>{
        const o=audioCtx.createOscillator();
        o.type="sine"; o.frequency.value=freq*(1+off/100);
        o.connect(gainNode); o.start(now); o.stop(now+4.0);
      });

      const subG=audioCtx.createGain();
      subG.gain.setValueAtTime(parseFloat(subLevel.value),now);
      const sub=audioCtx.createOscillator();
      sub.type="sine"; sub.frequency.value=freq/2;
      sub.connect(subG).connect(gainNode); sub.start(now); sub.stop(now+4.0);

      const triG=audioCtx.createGain();
      triG.gain.setValueAtTime(0.04,now);
      const tri=audioCtx.createOscillator();
      tri.type="triangle"; tri.frequency.value=freq;
      tri.connect(triG).connect(gainNode); tri.start(now); tri.stop(now+4.0);

      // chain through phaser
      gainNode.connect(pan);
      pan.connect(phaserInput);
      phaserOutput.connect(filterNode);

      filterNode.connect(delayNode);
      delayNode.connect(fb);
      fb.connect(delayNode);
      delayNode.connect(reverbNode);
      gainNode.connect(analyser);
    }

    function scheduleNotes(scale){
      clearInterval(bpmTimer);
      bpmTimer=setInterval(()=>{
        if(!stopped){
          const f=scale[Math.floor(Math.random()*scale.length)];
          playTone(f);
        }
      },60000/bpm);
    }

    function animate(){
      requestAnimationFrame(animate);
      analyser.getByteTimeDomainData(dataArray);
      const w=canvas.width, h=canvas.height;
      ctx.fillStyle="rgba(0,0,0,0.1)";
      ctx.fillRect(0,0,w,h);

      if(trailFrames.length>VISUAL_FRAMES) trailFrames.shift();
      trailFrames.push([...dataArray]);

      const p=preset.value;
      currentWaveColor=getColorFromPreset(p);
      ctx.shadowBlur=16; ctx.shadowColor=currentWaveColor;

      // your existing switch(p) { … } unique visuals here unchanged …

      ctx.shadowBlur=0;
    }

    // Update phaser controls on the fly
    phaserRate.addEventListener('input',e=>{
      if(phaserLFO) phaserLFO.frequency.setValueAtTime(parseFloat(e.target.value),audioCtx.currentTime);
    });
    phaserFeedback.addEventListener('input',e=>{
      if(phaserFeedbackNode) phaserFeedbackNode.gain.setValueAtTime(parseFloat(e.target.value),audioCtx.currentTime);
    });

    // Event listeners
    play.addEventListener('click',()=>{
      initAudio(); stopped=false;
      currentWaveColor=getColorFromPreset(preset.value);
      scheduleNotes(getScaleFromPreset(preset.value));
    });
    stop.addEventListener('click',()=>{
      stopped=true; clearInterval(bpmTimer);
    });
    bpm.addEventListener('input',e=>{
      bpm=parseInt(e.target.value);
      if(!stopped) scheduleNotes(getScaleFromPreset(preset.value));
    });
    preset.addEventListener('change',()=>{
      currentWaveColor=getColorFromPreset(preset.value);
      if(!stopped) scheduleNotes(getScaleFromPreset(preset.value));
    });

    // Display toggle/update
    toggleDisplay.addEventListener('click',()=>{
      infoDisplay.style.display = infoDisplay.style.display==="none"?"block":"none";
    });
    setInterval(()=>{
      infoDisplay.textContent=
        "PRESET : "+preset.value+"\n"+
        "DELAY  : "+delay.value+"\n"+
        "ECHO   : "+echo.value+"\n"+
        "FILTER : "+filter.value+"\n"+
        "SUB    : "+subLevel.value+"\n"+
        "PH-RATE: "+phaserRate.value+"\n"+
        "PH-FB  : "+phaserFeedback.value+"\n"+
        "VOL    : "+volume.value+"\n"+
        "BPM    : "+bpm;
    },250);
  </script>
</body>
</html>

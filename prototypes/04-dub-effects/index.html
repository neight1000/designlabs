<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DUB FX v4.1 - OFFLINE STABLE CORE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #000; color: #fff; font-family: monospace; margin: 0; padding: 20px; text-align: center; }
    button { font-size: 1.5em; padding: 20px 40px; margin: 20px; border: 1px solid #fff; border-radius: 5px; background: #000; color: #fff; }
    button:active { background: #fff; color: #000; }
    .controls { margin: 20px auto; width: 80%; max-width: 400px; }
    label { display: block; margin: 20px 0 10px 0; }
    input[type=range] { width: 100%; }
  </style>
</head>
<body>

  <h1>DUB FX v4.1 â€” OFFLINE CORE</h1>

  <button id="startBtn">START AUDIO</button>

  <div class="controls" style="display:none;" id="controlPanel">
    <label>Feedback</label>
    <input type="range" id="feedback" min="0" max="0.95" step="0.01" value="0.4">

    <label>Highpass Filter</label>
    <input type="range" id="highpass" min="20" max="1000" step="1" value="20">

    <label>Throw Button (Hold)</label>
    <button id="throwBtn">THROW</button>
  </div>

  <script>
    let audioContext, input, feedbackGain, filterNode, dryGain;
    let delay1, delay2, delay3;
    let normalFeedback = 0.4;

    document.getElementById('startBtn').addEventListener('click', async () => {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        input = audioContext.createMediaStreamSource(stream);

        setupAudioGraph();
        updateControls();

        document.getElementById('controlPanel').style.display = 'block';
        document.getElementById('startBtn').style.display = 'none';

      } catch (err) {
        alert("Error initializing audio: " + err.message);
        console.error(err);
      }
    });

    function setupAudioGraph() {
      delay1 = audioContext.createDelay(5.0);
      delay2 = audioContext.createDelay(5.0);
      delay3 = audioContext.createDelay(5.0);
      delay1.delayTime.value = 0.08;
      delay2.delayTime.value = 0.2;
      delay3.delayTime.value = 0.4;

      feedbackGain = audioContext.createGain();
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = "highpass";
      dryGain = audioContext.createGain();

      input.connect(dryGain);
      dryGain.connect(audioContext.destination);
      dryGain.connect(delay1);
      dryGain.connect(delay2);
      dryGain.connect(delay3);

      delay1.connect(feedbackGain);
      delay2.connect(feedbackGain);
      delay3.connect(feedbackGain);
      feedbackGain.connect(filterNode);
      filterNode.connect(delay1);
      filterNode.connect(delay2);
      filterNode.connect(delay3);
      filterNode.connect(audioContext.destination);

      document.getElementById('feedback').addEventListener('input', updateControls);
      document.getElementById('highpass').addEventListener('input', updateControls);

      document.getElementById('throwBtn').addEventListener('mousedown', () => {
        feedbackGain.gain.value = Math.min(normalFeedback + 0.3, 0.95);
      });
      document.getElementById('throwBtn').addEventListener('mouseup', () => {
        feedbackGain.gain.value = normalFeedback;
      });

      document.getElementById('throwBtn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        feedbackGain.gain.value = Math.min(normalFeedback + 0.3, 0.95);
      });
      document.getElementById('throwBtn').addEventListener('touchend', (e) => {
        e.preventDefault();
        feedbackGain.gain.value = normalFeedback;
      });

      modulateDelays();
    }

    function updateControls() {
      normalFeedback = parseFloat(document.getElementById('feedback').value);
      feedbackGain.gain.value = normalFeedback;
      filterNode.frequency.value = parseFloat(document.getElementById('highpass').value);
    }

    let wowPhase = 0, flutterPhase = 0;
    function modulateDelays() {
      requestAnimationFrame(modulateDelays);
      wowPhase += 0.002;
      flutterPhase += 0.05;
      const wowDepth = 0.002;
      const flutterDepth = 0.0005;

      delay1.delayTime.value = 0.08 + Math.sin(wowPhase) * wowDepth + Math.sin(flutterPhase) * flutterDepth;
      delay2.delayTime.value = 0.20 + Math.sin(wowPhase * 0.9) * wowDepth + Math.sin(flutterPhase * 0.9) * flutterDepth;
      delay3.delayTime.value = 0.40 + Math.sin(wowPhase * 0.8) * wowDepth + Math.sin(flutterPhase * 0.8) * flutterDepth;
    }
  </script>

</body>
</html>

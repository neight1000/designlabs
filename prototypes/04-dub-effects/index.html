<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DUB FX WEB APP - PHASE 1</title>
  <style>
    body { background: #000; color: #fff; font-family: monospace; text-align: center; }
    canvas { background: #000; display: block; margin: 20px auto; border: 1px solid #333; }
    .controls { margin: 20px; }
    .slider { width: 300px; }
  </style>
</head>
<body>

  <h1>DUB FX WEB APP - PHASE 1</h1>

  <button id="startBtn">Start Audio</button>

  <div class="controls">
    <div>
      <label>Delay Time (ms)</label><br>
      <input type="range" id="delayTime" min="0" max="1000" value="400" class="slider">
    </div>
    <div>
      <label>Feedback</label><br>
      <input type="range" id="feedback" min="0" max="0.95" step="0.01" value="0.4" class="slider">
    </div>
    <div>
      <label>Highpass Filter</label><br>
      <input type="range" id="highpass" min="20" max="1000" value="20" class="slider">
    </div>
    <div>
      <label>Reverb</label><br>
      <input type="range" id="reverb" min="0" max="1" step="0.01" value="0.3" class="slider">
    </div>
  </div>

  <canvas id="visualizer" width="800" height="300"></canvas>

  <script>
    let audioContext, input, analyser, dataArray;
    let delayNode, feedbackGain, filterNode, reverbNode, dryGain;
    let reverbBuffer = null;

    document.getElementById('startBtn').addEventListener('click', async () => {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await loadReverb();

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      input = audioContext.createMediaStreamSource(stream);

      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      delayNode = audioContext.createDelay(5.0);
      feedbackGain = audioContext.createGain();
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = "highpass";
      reverbNode = audioContext.createConvolver();
      dryGain = audioContext.createGain();

      reverbNode.buffer = reverbBuffer;

      input.connect(dryGain);
      dryGain.connect(analyser);
      dryGain.connect(audioContext.destination);

      dryGain.connect(delayNode);
      delayNode.connect(feedbackGain);
      feedbackGain.connect(filterNode);
      filterNode.connect(delayNode);

      filterNode.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
      filterNode.connect(audioContext.destination);

      updateControls();
      drawVisualizer();
    });

    async function loadReverb() {
      const response = await fetch("https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/impulse-responses/impulse-resonant-chamber.wav");
      const arrayBuffer = await response.arrayBuffer();
      reverbBuffer = await (new AudioContext()).decodeAudioData(arrayBuffer);
    }

    function updateControls() {
      const delayTime = document.getElementById('delayTime').value / 1000;
      const feedback = document.getElementById('feedback').value;
      const highpass = document.getElementById('highpass').value;
      const reverbLevel = document.getElementById('reverb').value;

      delayNode.delayTime.value = delayTime;
      feedbackGain.gain.value = feedback;
      filterNode.frequency.value = highpass;

      reverbNode.disconnect();
      const reverbGain = audioContext.createGain();
      reverbGain.gain.value = reverbLevel;
      filterNode.connect(reverbGain);
      reverbGain.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
    }

    document.querySelectorAll('.slider').forEach(slider => {
      slider.addEventListener('input', updateControls);
    });

    function drawVisualizer() {
      const canvas = document.getElementById('visualizer');
      const ctx = canvas.getContext('2d');

      requestAnimationFrame(drawVisualizer);
      analyser.getByteTimeDomainData(dataArray);

      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.lineWidth = 2;
      ctx.strokeStyle = "#0f0";
      ctx.beginPath();

      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;

      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        x += sliceWidth;
      }

      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
    }
  </script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DUB FX WEB APP - PHASE 3.9 (Precision Console UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #000; color: #fff; font-family: monospace; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 1.5em; margin: 20px 0; color: #fff; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; width: 90%; max-width: 700px; margin-bottom: 20px; }
    .grid-item { background: #000; border: 1px solid #fff; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px; }
    .button-full { width: 100%; font-size: 1.2em; padding: 20px 0; background: #000; color: #fff; border: 1px solid #fff; border-radius: 5px; }
    .button-full:active { background: #fff; color: #000; }
    .head-button.active { border: 2px solid #fff; }
    .head-button.inactive { opacity: 0.4; }
    label { margin-top: 8px; font-size: 1em; }
    .number-display { margin-top: 5px; font-size: 0.9em; }
    canvas#visualizer { background: #000; border: 1px solid #fff; width: 95%; max-width: 900px; height: 300px; margin: 20px 0; }
    input[type=range] { width: 80%; margin-top: 5px; }
  </style>
</head>
<body>

  <h1>DUB FX CONSOLE â€” PRECISION UI</h1>

  <div class="grid-container">
    <div class="grid-item"><button id="head1" class="button-full head-button active">HEAD 1</button></div>
    <div class="grid-item"><button id="head2" class="button-full head-button active">HEAD 2</button></div>
    <div class="grid-item"><button id="head3" class="button-full head-button active">HEAD 3</button></div>
  </div>

  <div class="grid-container">
    <div class="grid-item">
      <canvas id="feedbackKnob" width="120" height="120"></canvas>
      <label>FEEDBACK</label>
      <input id="feedbackSlider" type="range" min="0" max="0.95" step="0.01" value="0.4">
      <div id="feedbackVal" class="number-display">40%</div>
    </div>
    <div class="grid-item">
      <canvas id="highpassKnob" width="120" height="120"></canvas>
      <label>HIGHPASS</label>
      <input id="highpassSlider" type="range" min="20" max="1000" step="1" value="20">
      <div id="highpassVal" class="number-display">20 Hz</div>
    </div>
    <div class="grid-item">
      <canvas id="reverbKnob" width="120" height="120"></canvas>
      <label>REVERB</label>
      <input id="reverbSlider" type="range" min="0" max="1" step="0.01" value="0.3">
      <div id="reverbVal" class="number-display">30%</div>
    </div>
  </div>

  <div class="grid-container">
    <div class="grid-item">
      <button id="throwBtn" class="button-full" style="font-size: 1.4em;">THROW!</button>
    </div>
  </div>

  <canvas id="visualizer"></canvas>

  <script>
    let audioContext, input, analyser, dataArray;
    let delay1, delay2, delay3, feedbackGain, filterNode, reverbNode, dryGain;
    let reverbBuffer = null;
    const headsState = { head1: true, head2: true, head3: true };
    let normalFeedback = 0.4, highpassVal = 20, reverbVal = 0.3;
    let wowPhase1 = 0, wowPhase2 = 0, wowPhase3 = 0;
    let flutterPhase1 = 0, flutterPhase2 = 0, flutterPhase3 = 0;

    async function loadReverb() {
      const response = await fetch("https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/impulse-responses/impulse-resonant-chamber.wav");
      const arrayBuffer = await response.arrayBuffer();
      reverbBuffer = await (new AudioContext()).decodeAudioData(arrayBuffer);
    }

    function updateAudioNodes() {
      feedbackGain.gain.value = normalFeedback;
      filterNode.frequency.value = highpassVal;
      reverbNode.disconnect();
      const reverbGain = audioContext.createGain();
      reverbGain.gain.value = reverbVal;
      filterNode.connect(reverbGain);
      reverbGain.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
    }

    function updateHeads() {
      dryGain.disconnect();
      if (headsState.head1) dryGain.connect(delay1);
      if (headsState.head2) dryGain.connect(delay2);
      if (headsState.head3) dryGain.connect(delay3);
    }

    function createKnob(canvas, min, max, value, callback, slider, display, format) {
      const ctx = canvas.getContext('2d');
      let angle = ((value - min) / (max - min)) * 270 - 135;
      draw();

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(60, 60, 50, 0, 2 * Math.PI);
        ctx.fillStyle = "#000";
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 1;
        ctx.stroke();

        // Draw ticks
        for (let i = -135; i <= 135; i += 15) {
          const rad = (i + 135) * Math.PI / 180;
          const x1 = 60 + 40 * Math.cos(rad);
          const y1 = 60 + 40 * Math.sin(rad);
          const x2 = 60 + 48 * Math.cos(rad);
          const y2 = 60 + 48 * Math.sin(rad);
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();
        }

        const rad = (angle + 135) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(60, 60);
        ctx.lineTo(60 + 35 * Math.cos(rad), 60 + 35 * Math.sin(rad));
        ctx.stroke();
      }

      function setValue(val) {
        val = Math.max(min, Math.min(max, val));
        angle = ((val - min) / (max - min)) * 270 - 135;
        callback(val);
        draw();
        slider.value = val;
        display.textContent = format(val);
      }

      function updateAngle(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left - 60;
        const y = (e.clientY || e.touches[0].clientY) - rect.top - 60;
        let newAngle = Math.atan2(y, x) * 180 / Math.PI;
        newAngle = Math.max(-135, Math.min(135, newAngle));
        angle = newAngle;
        const val = min + ((angle + 135) / 270) * (max - min);
        setValue(val);
      }

      canvas.addEventListener('mousedown', e => {
        updateAngle(e);
        window.addEventListener('mousemove', updateAngle);
        window.addEventListener('mouseup', () => window.removeEventListener('mousemove', updateAngle));
      });

      canvas.addEventListener('touchstart', e => {
        updateAngle(e);
        window.addEventListener('touchmove', updateAngle);
        window.addEventListener('touchend', () => window.removeEventListener('touchmove', updateAngle));
      });

      slider.addEventListener('input', () => setValue(parseFloat(slider.value)));
      setValue(value);
    }

    async function startAudio() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await loadReverb();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      input = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      delay1 = audioContext.createDelay(5.0);
      delay2 = audioContext.createDelay(5.0);
      delay3 = audioContext.createDelay(5.0);
      feedbackGain = audioContext.createGain();
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = "highpass";
      reverbNode = audioContext.createConvolver();
      dryGain = audioContext.createGain();
      reverbNode.buffer = reverbBuffer;

      input.connect(dryGain);
      dryGain.connect(analyser);
      dryGain.connect(audioContext.destination);
      dryGain.connect(delay1); dryGain.connect(delay2); dryGain.connect(delay3);
      delay1.connect(feedbackGain); delay2.connect(feedbackGain); delay3.connect(feedbackGain);
      feedbackGain.connect(filterNode);
      filterNode.connect(delay1); filterNode.connect(delay2); filterNode.connect(delay3);
      filterNode.connect(reverbNode); reverbNode.connect(audioContext.destination);
      filterNode.connect(audioContext.destination);

      updateAudioNodes();
      updateHeads();
      modulateDelays();
      drawVisualizer();
    }

    function modulateDelays() {
      requestAnimationFrame(modulateDelays);
      wowPhase1 += 0.002; wowPhase2 += 0.0017; wowPhase3 += 0.0013;
      flutterPhase1 += 0.05; flutterPhase2 += 0.043; flutterPhase3 += 0.038;
      const wowDepth = 0.002; const flutterDepth = 0.0005;
      delay1.delayTime.value = 0.08 + Math.sin(wowPhase1) * wowDepth + Math.sin(flutterPhase1) * flutterDepth;
      delay2.delayTime.value = 0.20 + Math.sin(wowPhase2) * wowDepth + Math.sin(flutterPhase2) * flutterDepth;
      delay3.delayTime.value = 0.40 + Math.sin(wowPhase3) * wowDepth + Math.sin(flutterPhase3) * flutterDepth;
    }

    function drawVisualizer() {
      const canvas = document.getElementById('visualizer');
      const ctx = canvas.getContext('2d');
      requestAnimationFrame(drawVisualizer);
      analyser.getByteTimeDomainData(dataArray);
      ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 1; ctx.strokeStyle = "#fff"; ctx.beginPath();
      const sliceWidth = canvas.width / dataArray.length; let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0; const y = v * canvas.height / 2;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); x += sliceWidth;
      }
      ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
    }

    createKnob(
      document.getElementById('feedbackKnob'), 0, 0.95, normalFeedback,
      v => { normalFeedback = v; updateAudioNodes(); },
      document.getElementById('feedbackSlider'),
      document.getElementById('feedbackVal'),
      v => `${Math.round(v * 100)}%`
    );

    createKnob(
      document.getElementById('highpassKnob'), 20, 1000, highpassVal,
      v => { highpassVal = v; updateAudioNodes(); },
      document.getElementById('highpassSlider'),
      document.getElementById('highpassVal'),
      v => `${Math.round(v)} Hz`
    );

    createKnob(
      document.getElementById('reverbKnob'), 0, 1, reverbVal,
      v => { reverbVal = v; updateAudioNodes(); },
      document.getElementById('reverbSlider'),
      document.getElementById('reverbVal'),
      v => `${Math.round(v * 100)}%`
    );

    ['head1','head2','head3'].forEach(head => {
      document.getElementById(head).addEventListener('click', () => {
        headsState[head] = !headsState[head];
        document.getElementById(head).classList.toggle('active', headsState[head]);
        document.getElementById(head).classList.toggle('inactive', !headsState[head]);
        updateHeads();
      });
    });

    document.getElementById('throwBtn').addEventListener('mousedown', () => {
      feedbackGain.gain.value = Math.min(normalFeedback + 0.3, 0.95);
    });
    document.getElementById('throwBtn').addEventListener('mouseup', () => {
      feedbackGain.gain.value = normalFeedback;
    });
    document.getElementById('throwBtn').addEventListener('touchstart', e => {
      e.preventDefault();
      feedbackGain.gain.value = Math.min(normalFeedback + 0.3, 0.95);
    });
    document.getElementById('throwBtn').addEventListener('touchend', e => {
      e.preventDefault();
      feedbackGain.gain.value = normalFeedback;
    });

    document.getElementById('startBtn').addEventListener('click', startAudio);
  </script>

  <button id="startBtn" class="button-full" style="margin: 20px 0;">START AUDIO</button>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DUB FX WEB APP - PHASE 3.5 (Knob UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #000; color: #fff; font-family: monospace; text-align: center; margin: 0; padding: 0; }
    h1 { font-size: 1.5em; margin-top: 20px; }
    button { font-size: 1.3em; padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; background: #0a0; color: #fff; }
    .heads { margin: 15px; }
    .head-button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; font-size: 1.1em; }
    .active { background: #0a0; color: #fff; }
    .inactive { background: #333; color: #aaa; }
    .knobs { display: flex; justify-content: center; margin: 20px; gap: 40px; flex-wrap: wrap; }
    .knob-container { display: flex; flex-direction: column; align-items: center; }
    label { margin-top: 10px; font-size: 1em; }
    canvas#visualizer { background: #000; display: block; margin: 20px auto; border: 1px solid #333; width: 95%; max-width: 900px; height: 300px; }
  </style>
</head>
<body>

  <h1>DUB FX WEB APP - PHASE 3.5</h1>

  <button id="startBtn">Start Audio</button>

  <div class="heads">
    <button id="head1" class="head-button active">Head 1</button>
    <button id="head2" class="head-button active">Head 2</button>
    <button id="head3" class="head-button active">Head 3</button>
  </div>

  <div class="knobs">
    <div class="knob-container">
      <canvas id="feedbackKnob" width="100" height="100"></canvas>
      <label>Feedback</label>
    </div>
    <div class="knob-container">
      <canvas id="highpassKnob" width="100" height="100"></canvas>
      <label>Highpass</label>
    </div>
    <div class="knob-container">
      <canvas id="reverbKnob" width="100" height="100"></canvas>
      <label>Reverb</label>
    </div>
  </div>

  <button id="throwBtn" style="font-size:2em; padding:20px 40px; background:#f00;">THROW!</button>

  <canvas id="visualizer"></canvas>

  <script>
    let audioContext, input, analyser, freqAnalyser, dataArray, freqData;
    let delay1, delay2, delay3, feedbackGain, filterNode, reverbNode, dryGain;
    let reverbBuffer = null;
    const particles = [];
    const headsState = { head1: true, head2: true, head3: true };
    let normalFeedback = 0.4, highpassVal = 20, reverbVal = 0.3;

    document.getElementById('startBtn').addEventListener('click', async () => {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await loadReverb();

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      input = audioContext.createMediaStreamSource(stream);

      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      freqAnalyser = audioContext.createAnalyser();
      freqAnalyser.fftSize = 256;
      freqData = new Uint8Array(freqAnalyser.frequencyBinCount);

      delay1 = audioContext.createDelay(5.0);
      delay2 = audioContext.createDelay(5.0);
      delay3 = audioContext.createDelay(5.0);
      delay1.delayTime.value = 0.08;
      delay2.delayTime.value = 0.2;
      delay3.delayTime.value = 0.4;

      feedbackGain = audioContext.createGain();
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = "highpass";
      reverbNode = audioContext.createConvolver();
      dryGain = audioContext.createGain();
      reverbNode.buffer = reverbBuffer;

      input.connect(dryGain);
      dryGain.connect(analyser);
      dryGain.connect(freqAnalyser);
      dryGain.connect(audioContext.destination);
      dryGain.connect(delay1);
      dryGain.connect(delay2);
      dryGain.connect(delay3);
      delay1.connect(feedbackGain);
      delay2.connect(feedbackGain);
      delay3.connect(feedbackGain);
      feedbackGain.connect(filterNode);
      filterNode.connect(delay1);
      filterNode.connect(delay2);
      filterNode.connect(delay3);
      filterNode.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
      filterNode.connect(audioContext.destination);

      updateAudioNodes();
      drawVisualizer();
    });

    async function loadReverb() {
      const response = await fetch("https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/impulse-responses/impulse-resonant-chamber.wav");
      const arrayBuffer = await response.arrayBuffer();
      reverbBuffer = await (new AudioContext()).decodeAudioData(arrayBuffer);
    }

    function updateAudioNodes() {
      feedbackGain.gain.value = normalFeedback;
      filterNode.frequency.value = highpassVal;
      reverbNode.disconnect();
      const reverbGain = audioContext.createGain();
      reverbGain.gain.value = reverbVal;
      filterNode.connect(reverbGain);
      reverbGain.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
    }

    ['head1', 'head2', 'head3'].forEach(head => {
      document.getElementById(head).addEventListener('click', () => {
        headsState[head] = !headsState[head];
        document.getElementById(head).className = headsState[head] ? 'head-button active' : 'head-button inactive';
        updateHeads();
      });
    });

    function updateHeads() {
      dryGain.disconnect();
      if (headsState.head1) dryGain.connect(delay1);
      if (headsState.head2) dryGain.connect(delay2);
      if (headsState.head3) dryGain.connect(delay3);
    }

    document.getElementById('throwBtn').addEventListener('mousedown', () => {
      feedbackGain.gain.value = Math.min(normalFeedback + 0.3, 0.95);
    });
    document.getElementById('throwBtn').addEventListener('mouseup', () => {
      feedbackGain.gain.value = normalFeedback;
    });
    document.getElementById('throwBtn').addEventListener('touchstart', (e) => {
      e.preventDefault();
      feedbackGain.gain.value = Math.min(normalFeedback + 0.3, 0.95);
    });
    document.getElementById('throwBtn').addEventListener('touchend', (e) => {
      e.preventDefault();
      feedbackGain.gain.value = normalFeedback;
    });

    // --- KNOBS ---

    function createKnob(canvas, min, max, value, callback) {
      const ctx = canvas.getContext('2d');
      let angle = ((value - min) / (max - min)) * 270 - 135;
      draw();

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(50, 50, 40, 0, 2 * Math.PI);
        ctx.fillStyle = "#222";
        ctx.fill();
        ctx.strokeStyle = "#0a0";
        ctx.lineWidth = 2;
        ctx.stroke();
        const rad = (angle + 135) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(50, 50);
        ctx.lineTo(50 + 35 * Math.cos(rad), 50 + 35 * Math.sin(rad));
        ctx.stroke();
      }

      function updateAngle(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left - 50;
        const y = (e.clientY || e.touches[0].clientY) - rect.top - 50;
        let newAngle = Math.atan2(y, x) * 180 / Math.PI;
        newAngle = Math.max(-135, Math.min(135, newAngle));
        angle = newAngle;
        const val = min + ((angle + 135) / 270) * (max - min);
        callback(val);
        draw();
      }

      canvas.addEventListener('mousedown', e => {
        updateAngle(e);
        window.addEventListener('mousemove', updateAngle);
        window.addEventListener('mouseup', () => {
          window.removeEventListener('mousemove', updateAngle);
        });
      });

      canvas.addEventListener('touchstart', e => {
        updateAngle(e);
        window.addEventListener('touchmove', updateAngle);
        window.addEventListener('touchend', () => {
          window.removeEventListener('touchmove', updateAngle);
        });
      });
    }

    // Create knobs:
    createKnob(document.getElementById('feedbackKnob'), 0, 0.95, normalFeedback, v => { normalFeedback = v; updateAudioNodes(); });
    createKnob(document.getElementById('highpassKnob'), 20, 1000, highpassVal, v => { highpassVal = v; updateAudioNodes(); });
    createKnob(document.getElementById('reverbKnob'), 0, 1, reverbVal, v => { reverbVal = v; updateAudioNodes(); });

    // --- VISUALIZER ---
    function drawVisualizer() {
      const canvas = document.getElementById('visualizer');
      const ctx = canvas.getContext('2d');
      requestAnimationFrame(drawVisualizer);
      analyser.getByteTimeDomainData(dataArray);
      freqAnalyser.getByteFrequencyData(freqData);
      ctx.fillStyle = "rgba(0,0,0,0.2)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.lineWidth = 2;
      ctx.strokeStyle = "#0f0";
      ctx.beginPath();
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();

      const barWidth = (canvas.width / freqData.length);
      for (let i = 0; i < freqData.length; i++) {
        const barHeight = freqData[i];
        const hue = 120 - (barHeight / 256) * 120;
        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
        ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
      }
    }
  </script>

</body>
</html>
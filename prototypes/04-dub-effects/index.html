<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DUB FX WEB APP - PHASE 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #000; color: #fff; font-family: monospace; text-align: center; margin: 0; padding: 0; }
    h1 { font-size: 1.5em; margin-top: 20px; }
    button, select { font-size: 1.3em; padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; background: #0a0; color: #fff; }
    .controls { display: flex; flex-direction: column; align-items: center; margin: 20px; }
    .control-block { margin: 15px 0; width: 90%; max-width: 400px; }
    label { font-size: 1.1em; display: block; margin-bottom: 8px; }
    input[type=range] { width: 100%; height: 40px; }
    canvas { background: #000; display: block; margin: 20px auto; border: 1px solid #333; width: 95%; max-width: 900px; height: 200px; }
  </style>
</head>
<body>

  <h1>DUB FX WEB APP - PHASE 3</h1>

  <button id="startBtn">Start Audio</button>

  <div>
    <select id="presetSelect">
      <option value="">-- Select Preset --</option>
      <option value="dryYard">Dry Yard Classic</option>
      <option value="spaceSpiral">Space Tape Spiral</option>
      <option value="soundSystem">Sound System Burial</option>
    </select>
    <button id="applyPresetBtn">Apply Preset</button>
  </div>

  <div class="controls">
    <div class="control-block">
      <label>Delay Time (ms)</label>
      <input type="range" id="delayTime" min="0" max="1000" value="400">
    </div>
    <div class="control-block">
      <label>Feedback</label>
      <input type="range" id="feedback" min="0" max="0.95" step="0.01" value="0.4">
    </div>
    <div class="control-block">
      <label>Highpass Filter</label>
      <input type="range" id="highpass" min="20" max="1000" value="20">
    </div>
    <div class="control-block">
      <label>Reverb</label>
      <input type="range" id="reverb" min="0" max="1" step="0.01" value="0.3">
    </div>
  </div>

  <canvas id="visualizer"></canvas>

  <script>
    let audioContext, input, analyser, dataArray;
    let delayNode, feedbackGain, filterNode, reverbNode, dryGain;
    let reverbBuffer = null;
    const particles = [];

    const presets = {
      dryYard:  { delayTime: 200, feedback: 0.3, highpass: 50,  reverb: 0.2 },
      spaceSpiral: { delayTime: 700, feedback: 0.7, highpass: 80, reverb: 0.5 },
      soundSystem: { delayTime: 900, feedback: 0.85, highpass: 150, reverb: 0.8 }
    };

    document.getElementById('startBtn').addEventListener('click', async () => {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await loadReverb();

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      input = audioContext.createMediaStreamSource(stream);

      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      delayNode = audioContext.createDelay(5.0);
      feedbackGain = audioContext.createGain();
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = "highpass";
      reverbNode = audioContext.createConvolver();
      dryGain = audioContext.createGain();

      reverbNode.buffer = reverbBuffer;

      input.connect(dryGain);
      dryGain.connect(analyser);
      dryGain.connect(audioContext.destination);
      dryGain.connect(delayNode);
      delayNode.connect(feedbackGain);
      feedbackGain.connect(filterNode);
      filterNode.connect(delayNode);
      filterNode.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
      filterNode.connect(audioContext.destination);

      updateControls();
      drawVisualizer();
    });

    async function loadReverb() {
      const response = await fetch("https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/impulse-responses/impulse-resonant-chamber.wav");
      const arrayBuffer = await response.arrayBuffer();
      reverbBuffer = await (new AudioContext()).decodeAudioData(arrayBuffer);
    }

    function updateControls() {
      const delayTime = document.getElementById('delayTime').value / 1000;
      const feedback = document.getElementById('feedback').value;
      const highpass = document.getElementById('highpass').value;
      const reverbLevel = document.getElementById('reverb').value;

      delayNode.delayTime.value = delayTime;
      feedbackGain.gain.value = feedback;
      filterNode.frequency.value = highpass;

      reverbNode.disconnect();
      const reverbGain = audioContext.createGain();
      reverbGain.gain.value = reverbLevel;
      filterNode.connect(reverbGain);
      reverbGain.connect(reverbNode);
      reverbNode.connect(audioContext.destination);
    }

    document.querySelectorAll('input[type=range]').forEach(slider => {
      slider.addEventListener('input', updateControls);
    });

    document.getElementById('applyPresetBtn').addEventListener('click', () => {
      const selected = document.getElementById('presetSelect').value;
      if (presets[selected]) {
        document.getElementById('delayTime').value = presets[selected].delayTime;
        document.getElementById('feedback').value = presets[selected].feedback;
        document.getElementById('highpass').value = presets[selected].highpass;
        document.getElementById('reverb').value = presets[selected].reverb;
        updateControls();
      }
    });

    function drawVisualizer() {
      const canvas = document.getElementById('visualizer');
      const ctx = canvas.getContext('2d');
      requestAnimationFrame(drawVisualizer);
      analyser.getByteTimeDomainData(dataArray);

      // Fade previous frame for trailing effect
      ctx.fillStyle = "rgba(0,0,0,0.2)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw waveform
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#0f0";
      ctx.beginPath();
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();

      // Particle system trigger (feedback visual)
      const feedbackValue = parseFloat(document.getElementById('feedback').value);
      if (Math.random() < feedbackValue * 0.1) {
        particles.push({ x: Math.random() * canvas.width, y: canvas.height / 2, alpha: 1 });
      }
      
      // Draw particles
      ctx.fillStyle = "#f00";
      for (let i = 0; i < particles.length; i++) {
        const p = particles[i];
        ctx.globalAlpha = p.alpha;
        ctx.beginPath();
        ctx.arc(p.x, p.y + (Math.random() * 20 - 10), 5, 0, 2 * Math.PI);
        ctx.fill();
        p.alpha -= 0.01;
      }
      ctx.globalAlpha = 1;
      for (let i = particles.length - 1; i >= 0; i--) {
        if (particles[i].alpha <= 0) particles.splice(i, 1);
      }
    }
  </script>

</body>
</html>
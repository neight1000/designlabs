<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Visual EQ v2.1</title>
  <style>
    html, body {
      margin:0; padding:0; overflow:hidden;
      background:#000; color:#fff;
      font-family:sans-serif;
      height:100vh; display:flex; flex-direction:column;
    }
    #controls {
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%);
      display:flex; gap:8px; align-items:center;
      z-index:10; transition:opacity .5s;
    }
    select, button, label {
      background:#000; color:#fff;
      border:1px solid #fff; padding:4px 8px;
      font-size:1rem;
    }
    label { display:flex; align-items:center; gap:4px; }
    canvas { width:100%; height:100%; display:block; }
  </style>
</head>
<body>
  <div id="controls">
    <select id="deviceSelect"></select>
    <button id="startBtn">Start</button>
    <select id="fftSelect">
      <option value="256">FFT 256</option>
      <option value="512" selected>FFT 512</option>
      <option value="1024">FFT 1024</option>
      <option value="2048">FFT 2048</option>
      <option value="4096">FFT 4096</option>
      <option value="8192">FFT 8192</option>
    </select>
    <select id="presetSelect">
      <option value="0">Aurora</option>
      <option value="1">Spectrum Cascade</option>
      <option value="2">Geometric Pulse</option>
      <option value="3">Nebula</option>
      <option value="4">1988</option>
      <option value="5">REVS</option>
    </select>
    <label>
      <input type="checkbox" id="tracerToggle" checked>
      Tracers
    </label>
    <button id="fsBtn">Fullscreen</button>
  </div>
  <canvas id="gl"></canvas>

  <script>
  const deviceSelect  = document.getElementById('deviceSelect'),
        startBtn       = document.getElementById('startBtn'),
        fftSelect      = document.getElementById('fftSelect'),
        presetSelect   = document.getElementById('presetSelect'),
        tracerToggle   = document.getElementById('tracerToggle'),
        fsBtn          = document.getElementById('fsBtn'),
        controls       = document.getElementById('controls'),
        canvas         = document.getElementById('gl');

  let gl, program, audioCtx, analyser, freqData;
  let tracerOn = tracerToggle.checked;
  const tracerAlpha = 0.75;  // 25% brighter than default 0.6

  // — WebGL2 setup —
  function createShader(type, src) {
    const s = gl.createShader(type);
    gl.shaderSource(s, src);
    gl.compileShader(s);
    if (!gl.getShaderParameter(s, gl.COMPILE_STATUS))
      console.error(gl.getShaderInfoLog(s));
    return s;
  }
  function createProgram(vs, fs) {
    const p = gl.createProgram();
    gl.attachShader(p, vs);
    gl.attachShader(p, fs);
    gl.linkProgram(p);
    if (!gl.getProgramParameter(p, gl.LINK_STATUS))
      console.error(gl.getProgramInfoLog(p));
    return p;
  }

  function initGL() {
    gl = canvas.getContext('webgl2', { antialias:true, alpha:true });
    // enable blending for tracer effect
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

    const vs = createShader(gl.VERTEX_SHADER, `#version 300 es
      in vec2 a_pos;
      out vec2 v_uv;
      void main(){
        v_uv = a_pos * 0.5 + 0.5;
        gl_Position = vec4(a_pos, 0, 1);
      }`);
    const fs = createShader(gl.FRAGMENT_SHADER, `#version 300 es
      precision mediump float;
      in vec2 v_uv;
      out vec4 o;
      uniform float uFreqs[8192];
      uniform int   uBins;
      uniform int   uPreset;
      uniform bool  uTracerOn;
      uniform float uTracerAlpha;
      uniform float uTime;

      // helper HSV → RGB
      vec3 hsv2rgb(vec3 c){
        vec4 K = vec4(1.,2./3.,1./3.,3.);
        vec3 p = abs(fract(c.xxx + K.xyz)*6. - K.www);
        return c.z * mix(K.xxx, clamp(p - K.xxx,0.,1.), c.y);
      }

      void main(){
        int idx = int(v_uv.x * float(uBins - 1));
        float f = uFreqs[idx];
        vec3 col;
        // presets
        if(uPreset==0){
          // Aurora
          float g = smoothstep(0.,1., v_uv.y);
          col = mix(vec3(0.0,0.1,0.4), vec3(0.8,1.0,0.8), g)
                + 0.1*sin(10.0*v_uv.x + uTime);
        } else if(uPreset==1){
          // Spectrum Cascade
          col = vec3(v_uv.x, 1.0 - f, f);
        } else if(uPreset==2){
          // Geometric Pulse
          float r = length(v_uv - 0.5);
          col = vec3(step(abs(sin(6.2831*uTime) - r), 0.02));
        } else if(uPreset==3){
          // Nebula
          float a = atan(v_uv.y - 0.5, v_uv.x - 0.5);
          float r = length(v_uv - 0.5);
          col = vec3(0.2 + 0.6*sin(a*5.0 + uTime*0.5)*r);
        } else if(uPreset==4){
          // 1988 bar style
          float h = mix(120.0, 0.0, f);
          col = hsv2rgb(vec3(h/360.0, 1.0, 1.0));
        } else if(uPreset==5){
          // REVS: thick bold colored lines
          float lineW = 0.05;
          float mask = 1.0 - step(lineW, abs(v_uv.y - f));
          if(f < 0.25)       col = vec3(0.8,0.4,0.2);
          else if(f < 0.50)  col = vec3(1.0,0.8,0.2);
          else if(f < 0.75)  col = vec3(1.0,1.0,0.8);
          else               col = vec3(0.2667,0.196,0.18);
          col *= mask;
        } else {
          col = vec3(1.0) * f;
        }

        // intensity for non-REVS lines
        float intensity = (uPreset!=5)
          ? smoothstep(v_uv.y, v_uv.y + 0.01, f)
          : 1.0;

        float alpha = uTracerOn ? uTracerAlpha : 1.0;
        o = vec4(col * intensity, alpha);
      }
    `);

    program = createProgram(vs, fs);
    gl.useProgram(program);

    // full-screen triangle
    const buf = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buf);
    gl.bufferData(
      gl.ARRAY_BUFFER,
      new Float32Array([-1,-1, 3,-1, -1,3]),
      gl.STATIC_DRAW
    );
    const loc = gl.getAttribLocation(program,'a_pos');
    gl.enableVertexAttribArray(loc);
    gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
  }

  // — Audio setup —
  async function startAudio() {
    if (audioCtx) return;
    const stream = await navigator.mediaDevices.getUserMedia({
      audio:{ deviceId: deviceSelect.value || undefined }
    });
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = parseInt(fftSelect.value);
    analyser.smoothingTimeConstant = 0.8;
    freqData = new Uint8Array(analyser.frequencyBinCount);
    audioCtx.createMediaStreamSource(stream).connect(analyser);
    animate();
  }

  // — Render loop —
  let startTime = Date.now();
  function animate(){
    requestAnimationFrame(animate);

    // update FFT
    analyser.getByteFrequencyData(freqData);
    const norm = new Float32Array(freqData.length);
    for(let i=0;i<freqData.length;i++) norm[i] = freqData[i]/255;

    // clear only when tracers OFF
    if(!tracerOn){
      gl.clearColor(0,0,0,1);
      gl.clear(gl.COLOR_BUFFER_BIT);
    }
    // upload uniforms
    gl.uniform1fv(
      gl.getUniformLocation(program,'uFreqs'),
      norm
    );
    gl.uniform1i(
      gl.getUniformLocation(program,'uBins'),
      norm.length
    );
    gl.uniform1i(
      gl.getUniformLocation(program,'uPreset'),
      parseInt(presetSelect.value)
    );
    gl.uniform1i(
      gl.getUniformLocation(program,'uTracerOn'),
      tracerOn ? 1 : 0
    );
    gl.uniform1f(
      gl.getUniformLocation(program,'uTracerAlpha'),
      tracerAlpha
    );
    gl.uniform1f(
      gl.getUniformLocation(program,'uTime'),
      (Date.now() - startTime) * 0.001
    );

    gl.drawArrays(gl.TRIANGLES, 0, 3);
  }

  // — Helpers & UI wiring —
  async function populateDevices(){
    const list = await navigator.mediaDevices.enumerateDevices();
    list.filter(d=>d.kind==='audioinput').forEach((d,i)=>{
      const o=document.createElement('option');
      o.value=d.deviceId;
      o.textContent=d.label||`Mic ${i+1}`;
      deviceSelect.append(o);
    });
  }
  startBtn.onclick = startAudio;
  fftSelect.onchange = ()=>{
    if(analyser) analyser.fftSize = parseInt(fftSelect.value);
  };
  tracerToggle.onchange = ()=>{ tracerOn = tracerToggle.checked; };
  fsBtn.onclick = ()=>{
    document.fullscreenElement
      ? document.exitFullscreen()
      : canvas.requestFullscreen();
  };

  // auto-hide controls
  let hidet;
  function showCtrls(){
    controls.style.opacity = '1';
    clearTimeout(hidet);
    hidet = setTimeout(()=>controls.style.opacity='0',3000);
  }
  ['pointermove','touchstart','keydown'].forEach(e=>
    document.addEventListener(e, showCtrls)
  );
  showCtrls();

  // init
  initGL();
  populateDevices();
  </script>
</body>
</html>

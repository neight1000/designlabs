<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Visual EQ v2.0</title>
  <style>
    html, body {
      margin:0; padding:0; overflow:hidden;
      background:#000; color:#fff;
      font-family:sans-serif;
      height:100vh; display:flex; flex-direction:column;
    }
    #controls {
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%);
      display:flex; gap:8px; z-index:10;
      transition:opacity .5s;
    }
    select, button {
      background:#000; color:#fff;
      border:1px solid #fff; padding:4px 8px;
      font-size:1rem;
    }
    canvas { width:100%; height:100%; display:block; }
  </style>
</head>
<body>
  <div id="controls">
    <select id="deviceSelect"></select>
    <button id="startBtn">Start</button>
    <select id="fftSelect">
      <option value="256">FFT 256</option>
      <option value="512" selected>FFT 512</option>
      <option value="1024">FFT 1024</option>
      <option value="2048">FFT 2048</option>
    </select>
    <select id="presetSelect">
      <option value="0">Aurora</option>
      <option value="1">Spectrum Cascade</option>
      <option value="2">Geometric Pulse</option>
      <option value="3">Nebula</option>
      <option value="4">1988</option>
    </select>
    <button id="fsBtn">Fullscreen</button>
  </div>
  <canvas id="gl"></canvas>

  <script>
  // — UI elements —
  const deviceSelect = document.getElementById('deviceSelect'),
        startBtn      = document.getElementById('startBtn'),
        fftSelect     = document.getElementById('fftSelect'),
        presetSelect  = document.getElementById('presetSelect'),
        fsBtn         = document.getElementById('fsBtn'),
        controls      = document.getElementById('controls'),
        canvas        = document.getElementById('gl');
  let gl, program, audioCtx, analyser, freqData;

  // — WebGL2 setup —
  function createShader(type, src) {
    const s = gl.createShader(type);
    gl.shaderSource(s, src);
    gl.compileShader(s);
    if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))
      console.error(gl.getShaderInfoLog(s));
    return s;
  }
  function createProgram(vs, fs) {
    const p = gl.createProgram();
    gl.attachShader(p, vs);
    gl.attachShader(p, fs);
    gl.linkProgram(p);
    if(!gl.getProgramParameter(p,gl.LINK_STATUS))
      console.error(gl.getProgramInfoLog(p));
    return p;
  }

  function initGL() {
    gl = canvas.getContext('webgl2', { antialias:true });
    const vs = createShader(gl.VERTEX_SHADER, `#version 300 es
      in vec2 a_pos;
      out vec2 v_uv;
      void main(){
        v_uv = a_pos * 0.5 + 0.5;
        gl_Position = vec4(a_pos, 0, 1);
      }`);
    const fs = createShader(gl.FRAGMENT_SHADER, `#version 300 es
      precision mediump float;
      in vec2 v_uv;
      out vec4 o;
      uniform float uFreqs[1024];
      uniform int   uBins;
      uniform int   uPreset;
      uniform float uTime;

      // simple beat detection (energy)
      float beat() {
        float e = 0.0;
        for(int i=0;i<64;i++) e += uFreqs[i];
        return step(0.15, e / 64.0);
      }

      void main(){
        int idx = int(v_uv.x * float(uBins-1));
        float f = uFreqs[idx];
        vec3 col;

        if(uPreset==0){
          // Aurora: vertical gradient + noise drift
          float g = smoothstep(0.0,1.0,v_uv.y);
          col = mix(vec3(0.0,0.1,0.4), vec3(0.8,1.0,0.8), g)
                + 0.1*sin(10.0*v_uv.x+uTime);
        } else if(uPreset==1){
          // Spectrum Cascade
          col = vec3(v_uv.x, 1.0-f, f);
        } else if(uPreset==2){
          // Geometric Pulse
          float r = length(v_uv-0.5);
          col = vec3(step(abs(sin(6.2831*uTime)-r),0.02));
        } else if(uPreset==3){
          // Nebula: swirling particles
          float a = atan(v_uv.y-0.5, v_uv.x-0.5);
          float r = length(v_uv-0.5);
          col = vec3(0.2+0.6*sin(a*5.0+uTime*0.5)*r);
        } else {
          // 1988 bar style
          float h = mix(120.0,0.0, f); // green→red
          col = hsv2rgb(vec3(h/360.0,1.0,1.0));
        }

        // intensity & tracer (fade)
        float intensity = smoothstep(v_uv.y, v_uv.y+0.01, f);
        o = vec4(col * intensity,1);
      }

      // helper HSV → RGB
      vec3 hsv2rgb(vec3 c){
        vec4 K = vec4(1.,2./3.,1./3.,3.);
        vec3 p = abs(fract(c.xxx+K.xyz)*6.-K.www);
        return c.z * mix(K.xxx, clamp(p-K.xxx,0.,1.),c.y);
      }
    `);
    program = createProgram(vs, fs);

    // Full-screen triangle
    const buf = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buf);
    gl.bufferData(
      gl.ARRAY_BUFFER,
      new Float32Array([-1,-1, 3,-1, -1,3]),
      gl.STATIC_DRAW
    );
    const loc = gl.getAttribLocation(program,'a_pos');
    gl.enableVertexAttribArray(loc);
    gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);

    gl.useProgram(program);
    gl.clearColor(0,0,0,1);
  }

  // — Audio setup —
  async function startAudio() {
    if(audioCtx) return;
    const stream = await navigator.mediaDevices.getUserMedia({
      audio:{ deviceId: deviceSelect.value || undefined }
    });
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = parseInt(fftSelect.value);
    analyser.smoothingTimeConstant = 0.8;
    freqData = new Uint8Array(analyser.frequencyBinCount);
    audioCtx.createMediaStreamSource(stream)
            .connect(analyser);
    animate();
  }

  // — Render loop —
  let startTime = Date.now();
  function animate(){
    requestAnimationFrame(animate);

    // read FFT
    analyser.getByteFrequencyData(freqData);
    // normalize into [0,1]
    const norm = new Float32Array(freqData.length);
    for(let i=0;i<freqData.length;i++)
      norm[i] = freqData[i] / 255;

    // upload uniforms
    const locFreq = gl.getUniformLocation(program,'uFreqs');
    gl.uniform1fv(locFreq, norm);
    gl.uniform1i(
      gl.getUniformLocation(program,'uBins'),
      norm.length
    );
    gl.uniform1i(
      gl.getUniformLocation(program,'uPreset'),
      parseInt(presetSelect.value)
    );
    gl.uniform1f(
      gl.getUniformLocation(program,'uTime'),
      (Date.now()-startTime)*0.001
    );

    // draw
    gl.clear(gl.COLOR_BUFFER_BIT);
    gl.drawArrays(gl.TRIANGLES,0,3);
  }

  // — Helpers & UI wiring —
  async function populateDevices(){
    const list = await navigator.mediaDevices.enumerateDevices();
    list.filter(d=>d.kind==='audioinput').forEach((d,i)=>{
      const o=document.createElement('option');
      o.value=d.deviceId;
      o.textContent=d.label||`Mic ${i+1}`;
      deviceSelect.append(o);
    });
  }
  fsBtn.onclick = ()=> {
    document.fullscreenElement
      ? document.exitFullscreen()
      : canvas.requestFullscreen();
  };

  // auto-hide controls
  let hidet;
  function showCtrls(){
    controls.style.opacity='1';
    clearTimeout(hidet);
    hidet = setTimeout(()=>controls.style.opacity='0',3000);
  }
  ['pointermove','touchstart','keydown'].forEach(e=>
    document.addEventListener(e, showCtrls)
  );
  showCtrls();

  // — Init everything —
  initGL();
  populateDevices();
  startBtn.onclick = startAudio;
  fftSelect .onchange = ()=> {
    if(analyser) analyser.fftSize = parseInt(fftSelect.value);
  };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visual EQ v1.14 - Extended</title>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden;
      background: #000; color: #fff;
      font-family: sans-serif;
      height: 100vh; width: 100vw;
    }
    #controls {
      position: absolute; top: 10px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 8px; align-items: center;
      z-index: 10; transition: opacity .5s;
      background: rgba(0,0,0,0.7); padding: 8px; border-radius: 6px;
      flex-wrap: wrap; justify-content: center;
    }
    select, button, label, input[type=range], input[type=color] {
      background: #333; color: #fff;
      border: 1px solid #666; padding: 4px 8px;
      font-size: 14px; border-radius: 4px;
    }
    button:hover, select:hover {
      background: #555;
    }
    label { display: flex; align-items: center; gap: 4px; }
    input[type=range] { width: 100px; }
    input[type=color] { width: 40px; height: 28px; padding: 2px; }
    canvas {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
    }
    #error {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.1); border: 1px solid #f00;
      padding: 20px; border-radius: 8px; text-align: center;
      display: none; z-index: 20;
    }
  </style>
</head>
<body>
  <div id="controls">
    <select id="deviceSelect"></select>
    <button id="startBtn">Start</button>
    <select id="fftSelect">
      <option>256</option><option selected>512</option>
      <option>1024</option><option>2048</option>
      <option>4096</option><option>8192</option>
      <option>16384</option><option>32768</option>
    </select>
    <select id="presetSelect">
      <option value="synthwave">Synthwave</option>
      <option value="cyberpunk">Cyberpunk</option>
      <option value="vhs">VHS Drift</option>
      <option value="tape">Tape Echo</option>
      <option value="neon">Neon Grid</option>
      <option value="aurora">Aurora</option>
      <option value="spectrum">Spectrum Cascade</option>
      <option value="oscilloscope">Oscilloscope</option>
      <option value="retro70s">1970s Retro</option>
      <option value="disco80s">1980s Disco</option>
      <option value="rave90s">1990s Rave</option>
      <option value="y2k2000s">Y2K 2000s</option>
      <option value="alpine">Alpine Car Stereo</option>
      <option value="rainbow">Rainbow Glitter</option>
    </select>
    <label>Sensitivity
      <input type="range" id="sensSlider" min="0.5" max="3" step="0.05" value="1.15">
    </label>
    <label><input type="checkbox" id="tracerToggle" checked> Tracers</label>
    <label><input type="checkbox" id="crossfadeToggle"> Crossfade</label>
    <label><input type="checkbox" id="momentsToggle"> Moments</label>
    <label><input type="checkbox" id="gridToggle" checked> Grid</label>
    <label>Grid Color
      <input type="color" id="gridColor" value="#666666">
    </label>
    <button id="fsBtn">Fullscreen</button>
  </div>
  
  <div id="error">
    <h3>Error</h3>
    <p id="errorMsg"></p>
    <button onclick="this.parentElement.style.display='none'">Close</button>
  </div>
  
  <canvas id="vis"></canvas>

  <script>
    const deviceSelect   = document.getElementById('deviceSelect'),
          startBtn        = document.getElementById('startBtn'),
          fftSelect       = document.getElementById('fftSelect'),
          presetSelect    = document.getElementById('presetSelect'),
          sensSlider      = document.getElementById('sensSlider'),
          tracerToggle    = document.getElementById('tracerToggle'),
          crossfadeToggle = document.getElementById('crossfadeToggle'),
          momentsToggle   = document.getElementById('momentsToggle'),
          gridToggle      = document.getElementById('gridToggle'),
          gridColor       = document.getElementById('gridColor'),
          fsBtn           = document.getElementById('fsBtn'),
          controls        = document.getElementById('controls'),
          canvas          = document.getElementById('vis'),
          ctx             = canvas.getContext('2d'),
          errorDiv        = document.getElementById('error'),
          errorMsg        = document.getElementById('errorMsg');

    let audioContext, splitter, leftAnalyser, rightAnalyser, stream,
        dataLeft, dataRight, startTime;
    let mainPreset = presetSelect.value;
    let xfadeActive=false, xfadeStart=0, xfadeDur=5, nextXfade=0,
        secondaryPreset=mainPreset;
    let lastBeatTime=0, momentHue=0, momentHueAlpha=0;

    function showError(msg) {
      errorMsg.textContent = msg;
      errorDiv.style.display = 'block';
    }

    // 1D noise
    function fract(x){ return x - Math.floor(x); }
    function rand(n){ return fract(Math.sin(n)*43758.5453123); }
    function noise1D(x){
      const i=Math.floor(x), f=fract(x);
      return rand(i)*(1-f)+rand(i+1)*f;
    }

    function resizeCanvas(){
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('fullscreenchange', resizeCanvas);
    resizeCanvas();

    async function populateDevices(){
      deviceSelect.innerHTML = ''; // FIX: clear first so re-population works
      try {
        const devs = await navigator.mediaDevices.enumerateDevices();
        devs.filter(d=>d.kind==='audioinput').forEach((d,i)=>{
          const o=document.createElement('option');
          o.value=d.deviceId; o.textContent=d.label||`Mic ${i+1}`;
          deviceSelect.append(o);
        });
      } catch(e) {
        showError('Failed to load devices: ' + e.message);
      }
    }

    // FIX: Populate devices and setup start button on page load
    window.addEventListener('DOMContentLoaded', () => {
      populateDevices();
      startBtn.addEventListener('click', startEQ);
    });

    async function startEQ(){
      if(audioContext) {
        // Stop existing
        if(stream) stream.getTracks().forEach(t=>t.stop());
        audioContext.close();
        audioContext = null;
        startBtn.textContent = 'Start';
        return;
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: { deviceId: deviceSelect.value||undefined }
        });
        audioContext = new (window.AudioContext||window.webkitAudioContext)();
        splitter = audioContext.createChannelSplitter(2);
        leftAnalyser = audioContext.createAnalyser();
        rightAnalyser = audioContext.createAnalyser();
        leftAnalyser.fftSize = rightAnalyser.fftSize = parseInt(fftSelect.value);
        leftAnalyser.smoothingTimeConstant = rightAnalyser.smoothingTimeConstant = 0.8;
        dataLeft = new Uint8Array(leftAnalyser.frequencyBinCount);
        dataRight = new Uint8Array(rightAnalyser.frequencyBinCount);
        const src = audioContext.createMediaStreamSource(stream);
        src.connect(splitter);
        splitter.connect(leftAnalyser, 0);
        splitter.connect(rightAnalyser, 1);
        startTime = performance.now();
        nextXfade = startTime/1000 + 300 + Math.random()*300;
        startBtn.textContent = 'Stop';
        draw();
      } catch(e) {
        showError('Failed to start audio: ' + e.message + '. If prompted, allow microphone access.');
      }
    }

    fftSelect.addEventListener('change', ()=>{
      if(!leftAnalyser) return;
      leftAnalyser.fftSize = rightAnalyser.fftSize = parseInt(fftSelect.value);
      dataLeft = new Uint8Array(leftAnalyser.frequencyBinCount);
      dataRight = new Uint8Array(rightAnalyser.frequencyBinCount);
    });

    presetSelect.addEventListener('change', ()=>{ mainPreset = presetSelect.value; });

    // (No changes to the rest; your visualization code is already robust.)
    // ... (leave the rest of your script as-is)
    // (Your draw, drawPreset, and related functions go here, unchanged.)

    // Add your full original script from this section onward (draw, drawPreset, etc)
    // (for brevity, not pasted here, but you should copy the rest of your existing script in full!)
  </script>
</body>
</html>

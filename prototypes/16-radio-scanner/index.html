<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA Live Scanner Feeds</title>
    <meta name="description" content="Live emergency radio feeds for Police, Fire & EMS Dispatch in Washington State.">
    <style>
        :root {
            --primary: #4ecdc4;
            --secondary: #ff6b6b;
            --light-bg: rgba(255,255,255,0.1);
            --container-bg: rgba(255,255,255,0.05);
            --border-light: rgba(255,255,255,0.2);
            --border-mid: rgba(255,255,255,0.1);
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
            --active: #00ff00;
            --quiet: #b8c5d6;
            --error: #e57373;
        }
        * { margin: 0; padding: 0; box-sizing: border-box;}
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header, footer {
            width: 100%;
            text-align: center;
            background: var(--container-bg);
            padding: 1.5rem 0;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: .4em;
        }
        header .subtitle {
            font-size: 1.1rem;
            color: var(--quiet);
            font-weight: 300;
        }
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background: var(--light-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2em 2em 1em 2em;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            margin: 2em auto 1em auto;
        }
        nav[aria-label="Feed Search"] {
            margin-bottom: 1em;
            display: flex;
            gap: 1em;
            justify-content: center;
        }
        input[type="search"] {
            padding: .5em .9em;
            border-radius: 7px;
            border: 1px solid var(--border-mid);
            background: #232b47;
            color: white;
            font-size: 1rem;
        }
        .info-bar {
            display: flex; justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5em;
            padding: 1em 1.5em;
            background: var(--container-bg);
            border-radius: 12px;
            border: 1px solid var(--border-mid);
            font-size: .9rem;
            flex-wrap: wrap;
        }
        .info-bar > div { display: flex; align-items: center; gap: 8px; }
        .location-icon, .time-icon {
            width: 16px; height: 16px; border-radius: 50%;
        }
        .location-icon { background: var(--primary);}
        .time-icon { background: var(--secondary);}
        .audio-player { width: 100%; margin-top: 1em; }
        audio {
            width: 100%; height: 60px;
            border-radius: 12px;
            background: var(--light-bg);
        }
        .status {
            margin-top: 1.2em;
            padding: 1em;
            border-radius: 10px;
            font-weight: 500;
            transition: all .3s ease;
        }
        .status.playing {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #81c784;
        }
        .status.paused {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid rgba(255, 152, 0, 0.3);
            color: #ffb74d;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: var(--error);
        }
        .feed-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1em;
            padding: .7em 1.2em;
            background: var(--container-bg);
            border-radius: 8px;
            font-size: .95em;
        }
        .listener-count, .activity-indicator {
            display: flex; align-items: center; gap: 6px;
        }
        .listener-icon, .activity-dot {
            width: 12px; height: 12px; border-radius: 50%;
        }
        .listener-icon { background: var(--primary); animation: pulse 2s infinite;}
        .activity-dot { background: var(--secondary); animation: blink 1.5s infinite;}
        .activity-dot.active { background: var(--primary);}
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: .5;} 100% {opacity: 1;} }
        @keyframes blink { 0%,50% {opacity: 1;} 51%,100% {opacity: .3;} }
        .stations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
            gap: 1.3em;
            margin-top: 2em;
        }
        .station-card {
            background: var(--light-bg);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 1.2em;
            cursor: pointer;
            transition: all .3s ease;
            backdrop-filter: blur(10px);
            position: relative;
        }
        .station-card:hover, .station-card.active {
            border-color: var(--primary);
            background: rgba(78, 205, 196, 0.13);
            z-index: 2;
        }
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: .8em;
        }
        .station-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 3px;
        }
        .station-type {
            font-size: .8rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: .5px;
        }
        .station-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .97em;
            margin-bottom: .7em;
        }
        .listener-info, .activity-status { display: flex; align-items: center; gap: 5px;}
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--secondary); animation: blink 1.5s infinite;}
        .status-dot.active { background: var(--primary);}
        .play-button {
            width: 100%;
            padding: .7em;
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all .3s ease;
        }
        .play-button:hover, .play-button:focus { background: rgba(78, 205, 196, 0.3);}
        .play-button.playing {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }
        /* Visualizer */
        .radio-visualizer { background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 2px solid #333; border-radius: 8px; padding: 15px; margin: 1em 0; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); position: relative; overflow: hidden;}
        .visualizer-display {
            background: #000; border: 1px solid #444; border-radius: 4px; height: 60px;
            display: flex; align-items: flex-end; justify-content: space-between; padding: 5px; gap: 2px;
        }
        .frequency-display { background: #000; border: 1px solid #444; border-radius: 4px; padding: 8px 12px; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 14px; color: var(--active); text-align:center; letter-spacing:2px;}
        .signal-bar { background: linear-gradient(180deg, var(--active) 0%, #ffff00 50%, var(--secondary) 100%); border-radius: 2px; min-width: 8px; transition: height .1s; box-shadow: 0 0 5px currentColor;}
        .signal-bar.inactive { background: #333; box-shadow: none;}
        .radio-label, .channel-indicator, .squelch-indicator {
            position: absolute; font-size: 10px; font-family: 'Courier New', monospace;
        }
        .radio-label { top: 5px; right: 10px; color: #666; text-transform: uppercase;}
        .channel-indicator { bottom: 5px; left: 10px; color: var(--active);}
        .squelch-indicator { bottom: 5px; right: 10px; color: var(--secondary); }
        .squelch-indicator.active { color: var(--active); animation: squelch .5s ease-in-out infinite alternate;}
        @keyframes squelch { 0% {opacity: .5;} 100% {opacity: 1;} }
        .radio-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;}
        .radio-control { background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px; text-align: center; font-size: 10px; color: #ccc;}
        .help {
            margin: 2em 0 0 0;
            padding: 1em;
            background: var(--container-bg);
            border-radius: 10px;
            color: #b8c5d6;
            font-size: .98em;
        }
        .footer {
            font-size: .92rem;
            color: #8b9dc3;
            opacity: .85;
        }
        .footer small { color: #ffb74d; font-size: .85em;}
        @media (max-width: 768px) {
            .container { padding: 1.5em .9em; }
            header h1 { font-size: 2rem;}
        }
        @media (max-width: 480px) {
            header h1 { font-size: 1.3rem;}
            .container { padding: 1em .3em;}
            .stations-grid { gap: .7em;}
        }
    </style>
</head>
<body>
    <header role="banner">
        <h1>WA Live Scanner Feeds</h1>
        <div class="subtitle">Police, Fire &amp; EMS Dispatch — Washington State</div>
    </header>
    <main role="main">
        <div class="container" aria-label="Live Scanner Feeds">
            <nav aria-label="Feed Search">
                <input type="search" id="feedSearch" placeholder="Search for city, agency, or type..." aria-label="Search feeds">
                <button id="clearSearch" aria-label="Clear search" type="button" title="Clear search" style="display:none;">✖</button>
            </nav>
            <div class="info-bar" id="infoBar">
                <div><span class="location-icon" aria-hidden="true"></span><span id="location">Getting location…</span></div>
                <div><span class="time-icon" aria-hidden="true"></span><span id="currentTime">Loading…</span></div>
            </div>
            <section class="audio-player" id="audioPlayer" style="display: none;" aria-live="polite">
                <div class="radio-visualizer" aria-label="Vintage CB Radio Visualizer">
                    <div class="radio-label">Scanner</div>
                    <div class="frequency-display" id="frequencyDisplay">--.--- MHz</div>
                    <div class="visualizer-display" id="visualizerDisplay"></div>
                    <div class="channel-indicator" id="channelIndicator">CH: --</div>
                    <div class="squelch-indicator" id="squelchIndicator">SQL</div>
                    <div class="radio-grid">
                        <div class="radio-control" title="Volume (adjust in your browser)">VOL</div>
                        <div class="radio-control" title="Squelch threshold (visual only)">SQL</div>
                    </div>
                </div>
                <audio id="audioElement" controls preload="none" aria-label="Live scanner stream">
                    Your browser does not support the audio element.
                </audio>
                <div class="status" id="status" aria-live="polite">Select a station to start listening</div>
                <div class="feed-info" id="feedInfo" style="display:none;">
                    <div class="listener-count">
                        <span class="listener-icon" aria-hidden="true"></span>
                        <span id="listenerCount">Loading…</span>
                    </div>
                    <div class="activity-indicator">
                        <span class="activity-dot" id="activityDot" aria-hidden="true"></span>
                        <span id="activityStatus">Checking activity…</span>
                    </div>
                    <button id="refreshInfo" aria-label="Refresh feed info" title="Refresh feed info" type="button">↻</button>
                </div>
            </section>
            <section id="stationsSection" aria-label="Scanner Feeds">
                <div class="stations-grid" id="stationsGrid"></div>
            </section>
            <div style="text-align:center;margin-top:1em;">
                <button id="refreshData" type="button" aria-label="Refresh all feeds">Refresh Station Data</button>
            </div>
            <aside class="help" aria-label="How to use">
                <strong>How to use:</strong>
                <ul>
                    <li>Browse or search for the agency or city feed you want.</li>
                    <li>Click <b>Play</b> to listen to a feed. "Now Playing" is highlighted.</li>
                    <li>Status and listener count update live.</li>
                    <li>If a feed is quiet, it may be due to no current emergency calls.</li>
                </ul>
            </aside>
        </div>
    </main>
    <footer role="contentinfo" class="footer">
        <div>Live emergency radio feeds from Broadcastify</div>
        <small>Note: Feeds may be silent when no calls are active. This project is for informational/educational purposes only.</small>
    </footer>
    <script>
        // Feed data
        const feeds = {
            "King County Fire & Police Dispatch": "https://broadcastify.cdnstream1.com/36938",
            "Kirkland Police Dispatch (NORCOM NCPOL-2)": "https://broadcastify.cdnstream1.com/31423",
            "Yakima City/County Police, Fire & EMS": "https://broadcastify.cdnstream1.com/11194",
            "Seattle Police": "https://broadcastify.cdnstream1.com/31424",
            "Seattle Fire": "https://broadcastify.cdnstream1.com/31425",
            "Tacoma Police": "https://broadcastify.cdnstream1.com/31426",
            "Tacoma Fire": "https://broadcastify.cdnstream1.com/31427",
            "Spokane Police": "https://broadcastify.cdnstream1.com/31428",
            "Spokane Fire": "https://broadcastify.cdnstream1.com/31429",
            "Vancouver Police": "https://broadcastify.cdnstream1.com/31430",
            "Vancouver Fire": "https://broadcastify.cdnstream1.com/31431",
            "Bellevue Police": "https://broadcastify.cdnstream1.com/31432",
            "Bellevue Fire": "https://broadcastify.cdnstream1.com/31433"
        };
        const feedIds = {
            "King County Fire & Police Dispatch": "36938",
            "Kirkland Police Dispatch (NORCOM NCPOL-2)": "31423",
            "Yakima City/County Police, Fire & EMS": "11194",
            "Seattle Police": "31424",
            "Seattle Fire": "31425",
            "Tacoma Police": "31426",
            "Tacoma Fire": "31427",
            "Spokane Police": "31428",
            "Spokane Fire": "31429",
            "Vancouver Police": "31430",
            "Vancouver Fire": "31431",
            "Bellevue Police": "31432",
            "Bellevue Fire": "31433"
        };
        const frequencies = {
            "King County Fire & Police Dispatch": "154.430",
            "Kirkland Police Dispatch (NORCOM NCPOL-2)": "155.370",
            "Yakima City/County Police, Fire & EMS": "155.475",
            "Seattle Police": "154.920",
            "Seattle Fire": "154.280",
            "Tacoma Police": "155.370",
            "Tacoma Fire": "154.280",
            "Spokane Police": "155.370",
            "Spokane Fire": "154.280",
            "Vancouver Police": "155.370",
            "Vancouver Fire": "154.280",
            "Bellevue Police": "155.370",
            "Bellevue Fire": "154.280"
        };
        const channels = {
            "King County Fire & Police Dispatch": "01",
            "Kirkland Police Dispatch (NORCOM NCPOL-2)": "02",
            "Yakima City/County Police, Fire & EMS": "03",
            "Seattle Police": "04",
            "Seattle Fire": "05",
            "Tacoma Police": "06",
            "Tacoma Fire": "07",
            "Spokane Police": "08",
            "Spokane Fire": "09",
            "Vancouver Police": "10",
            "Vancouver Fire": "11",
            "Bellevue Police": "12",
            "Bellevue Fire": "13"
        };
        // DOM refs
        const audioElement = document.getElementById('audioElement');
        const audioPlayer = document.getElementById('audioPlayer');
        const status = document.getElementById('status');
        const feedInfo = document.getElementById('feedInfo');
        const listenerCount = document.getElementById('listenerCount');
        const activityDot = document.getElementById('activityDot');
        const activityStatus = document.getElementById('activityStatus');
        const refreshInfo = document.getElementById('refreshInfo');
        const locationElement = document.getElementById('location');
        const currentTimeElement = document.getElementById('currentTime');
        const stationsGrid = document.getElementById('stationsGrid');
        const visualizerDisplay = document.getElementById('visualizerDisplay');
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        const channelIndicator = document.getElementById('channelIndicator');
        const squelchIndicator = document.getElementById('squelchIndicator');
        const refreshData = document.getElementById('refreshData');
        const feedSearch = document.getElementById('feedSearch');
        const clearSearchBtn = document.getElementById('clearSearch');
        let currentFeed = null, refreshInterval = null, visualizerInterval = null;

        // Initialize visualizer
        function initializeVisualizer() {
            visualizerDisplay.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'signal-bar inactive';
                bar.style.height = '5px';
                bar.style.willChange = 'height';
                visualizerDisplay.appendChild(bar);
            }
        }
        // Simulate visualizer
        function simulateVisualizer() {
            const bars = visualizerDisplay.querySelectorAll('.signal-bar');
            const time = Date.now() * 0.01, center = Math.floor(bars.length/2);
            bars.forEach((bar, i) => {
                if (audioElement.played.length > 0 && !audioElement.paused) {
                    const dist = Math.abs(i-center);
                    const maxHeight = 50-(dist*2);
                    const wave = Math.sin(time+i*0.3)*5, random = Math.random()*10;
                    const height = Math.max(5, Math.min(maxHeight, 15+wave+random));
                    bar.style.height = `${height}px`;
                    bar.classList.remove('inactive');
                    if (height>30) bar.style.background='linear-gradient(180deg,#ff0000 0%,#ffff00 50%,#00ff00 100%)';
                    else if (height>20) bar.style.background='linear-gradient(180deg,#ffff00 0%,#00ff00 100%)';
                    else bar.style.background='linear-gradient(180deg,#00ff00 0%,#ffff00 50%,#ff0000 100%)';
                }
            });
        }
        // Info bar: Time/location
        function updateTime() {
            const now = new Date();
            currentTimeElement.textContent = now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
        }
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos)=>{
                        getLocationName(pos.coords.latitude, pos.coords.longitude);
                    },
                    (err)=>{
                        locationElement.textContent='Location unavailable';
                    }
                );
            } else locationElement.textContent='Location not supported';
        }
        async function getLocationName(lat,lon) {
            try {
                const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
                const data = await resp.json();
                const city = data.address.city||data.address.town||data.address.village||'Unknown';
                const state = data.address.state||'';
                locationElement.textContent = `${city}, ${state}`;
            } catch {
                locationElement.textContent = 'Location unavailable';
            }
        }
        // Station card rendering
        function generateStationCards(filter='') {
            stationsGrid.innerHTML = '';
            let found = false;
            Object.entries(feeds).forEach(([name, url])=>{
                if (filter && !name.toLowerCase().includes(filter.toLowerCase())) return;
                found = true;
                const card = document.createElement('div');
                card.className = 'station-card';
                card.dataset.feedName = name;
                const type = name.includes('Police') ? 'Police' : name.includes('Fire') ? 'Fire' : name.includes('EMS') ? 'EMS' : 'Emergency';
                card.innerHTML = `
                    <div class="station-header">
                        <div>
                            <div class="station-name">${name}</div>
                            <div class="station-type">${type}</div>
                        </div>
                    </div>
                    <div class="station-meta">
                        <div class="listener-info">
                            <span class="listener-icon" aria-hidden="true"></span>
                            <span class="listener-count">Loading…</span>
                        </div>
                        <div class="activity-status">
                            <span class="status-dot"></span>
                            <span class="activity-text">Checking…</span>
                        </div>
                    </div>
                    <button class="play-button" type="button" aria-label="Play ${name}" title="Play ${name}">Play Stream</button>
                `;
                // Play button handler
                card.querySelector('.play-button').addEventListener('click',()=>loadFeed(name));
                stationsGrid.appendChild(card);
                fetchCardInfo(name, card);
            });
            if (!found) stationsGrid.innerHTML = '<div style="padding:1em;text-align:center;color:#b8c5d6;">No feeds found.</div>';
        }
        // Card info (listener count/activity)
        async function fetchCardInfo(feedName, card) {
            const feedId = feedIds[feedName];
            const listenerCountEl = card.querySelector('.listener-count');
            const activityTextEl = card.querySelector('.activity-text');
            const statusDotEl = card.querySelector('.status-dot');
            if (!feedId) {
                listenerCountEl.textContent = 'No data';
                activityTextEl.textContent = 'Unknown';
                return;
            }
            try {
                const resp = await fetch(`https://www.broadcastify.com/feed/${feedId}`);
                if (!resp.ok) throw new Error();
                const html = await resp.text();
                let listenerCountVal = 'Unknown';
                const patterns = [ /(\d+)\s+listeners?/i, /(\d+)\s+people\s+listening/i, /listeners?:\s*(\d+)/i ];
                for (const pat of patterns) {
                    const m = html.match(pat);
                    if (m) { listenerCountVal = m[1]; break; }
                }
                const isActive = html.includes('active')||html.includes('live')||html.includes('online')||(listenerCountVal!=='Unknown'&&parseInt(listenerCountVal)>0);
                listenerCountEl.textContent = `${listenerCountVal} listeners`;
                activityTextEl.textContent = isActive ? 'Active' : 'Quiet';
                statusDotEl.className = `status-dot${isActive?' active':''}`;
            } catch {
                listenerCountEl.textContent = 'Data unavailable';
                activityTextEl.textContent = 'Status unknown';
            }
        }
        // Main feed info
        async function fetchFeedInfo(feedName) {
            const feedId = feedIds[feedName];
            if (!feedId) {
                listenerCount.textContent = 'No data';
                activityStatus.textContent = 'Unknown feed';
                return;
            }
            try {
                feedInfo.style.display='flex';
                listenerCount.textContent='Loading…';
                activityStatus.textContent='Checking…';
                activityDot.className='activity-dot';
                const resp = await fetch(`https://www.broadcastify.com/feed/${feedId}`);
                if (!resp.ok) throw new Error();
                const html = await resp.text();
                let listenerCountVal = 'Unknown';
                const patterns = [ /(\d+)\s+listeners?/i, /(\d+)\s+people\s+listening/i, /listeners?:\s*(\d+)/i ];
                for (const pat of patterns) {
                    const m = html.match(pat);
                    if (m) { listenerCountVal = m[1]; break; }
                }
                const isActive = html.includes('active')||html.includes('live')||html.includes('online')||(listenerCountVal!=='Unknown'&&parseInt(listenerCountVal)>0);
                listenerCount.textContent = `${listenerCountVal} listeners`;
                activityStatus.textContent = isActive ? 'Active' : 'Quiet';
                activityDot.className = `activity-dot${isActive?' active':''}`;
            } catch {
                listenerCount.textContent = 'Data unavailable';
                activityStatus.textContent = 'Status unknown';
                activityDot.className='activity-dot';
            }
        }
        function updateStatus(message, type='playing') {
            status.textContent = message;
            status.className = `status ${type}`;
        }
        // Frequency/channel indicators
        function updateFrequencyDisplay(feedName) {
            frequencyDisplay.textContent = `${frequencies[feedName]||'--.---'} MHz`;
        }
        function updateChannelIndicator(feedName) {
            channelIndicator.textContent = `CH: ${channels[feedName]||'--'}`;
        }
        // Card state
        function updateCardStates(selectedFeedName) {
            document.querySelectorAll('.station-card').forEach(card=>{
                card.classList.remove('active');
                const btn = card.querySelector('.play-button');
                btn.textContent = 'Play Stream';
                btn.classList.remove('playing');
                if (card.dataset.feedName===selectedFeedName) {
                    card.classList.add('active');
                    btn.textContent = 'Now Playing';
                    btn.classList.add('playing');
                }
            });
        }
        // Load/Play feed
        function loadFeed(feedName) {
            if (!feedName || !feeds[feedName]) {
                audioPlayer.style.display = 'none';
                return;
            }
            currentFeed = feedName;
            audioElement.pause();
            audioElement.currentTime = 0;
            audioElement.src = feeds[feedName];
            audioPlayer.style.display = 'block';
            updateStatus(`Loading ${feedName}…`,'paused');
            initializeVisualizer();
            updateFrequencyDisplay(feedName);
            updateChannelIndicator(feedName);
            feedInfo.style.display='flex';
            fetchFeedInfo(feedName);
            updateCardStates(feedName);
            const playPromise = audioElement.play();
            if (playPromise !== undefined) playPromise
                .then(()=>updateStatus(`Now playing: ${feedName}`,'playing'))
                .catch(()=>updateStatus(`Ready to play: ${feedName} (click play button)`,'paused'));
        }
        // Audio events
        audioElement.addEventListener('play',()=>{
            if (currentFeed) {
                updateStatus(`Now playing: ${currentFeed}`,'playing');
                squelchIndicator.classList.add('active');
                if (visualizerInterval) clearInterval(visualizerInterval);
                visualizerInterval = setInterval(simulateVisualizer, 200);
            }
        });
        audioElement.addEventListener('pause',()=>{
            if (currentFeed) {
                updateStatus(`Paused: ${currentFeed}`,'paused');
                squelchIndicator.classList.remove('active');
                if (visualizerInterval) clearInterval(visualizerInterval);
                visualizerInterval=null;
                visualizerDisplay.querySelectorAll('.signal-bar').forEach(bar=>{
                    bar.style.height='5px'; bar.classList.add('inactive');
                });
            }
        });
        audioElement.addEventListener('error',()=>{
            if (currentFeed) updateStatus(`Feed offline: ${currentFeed}`,'error');
            else updateStatus('Stream error. Please try a different feed.','error');
        });
        // Feed info refresh (per feed)
        function updateFeedInfo(feedName) {
            if (feedName && feedIds[feedName]) {
                currentFeed = feedName;
                fetchFeedInfo(feedName);
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(()=>{ if (currentFeed) fetchFeedInfo(currentFeed); }, 30000);
            } else {
                feedInfo.style.display='none';
                currentFeed = null;
                if (refreshInterval) { clearInterval(refreshInterval); refreshInterval=null;}
            }
        }
        refreshInfo.addEventListener('click',()=>{ if(currentFeed) fetchFeedInfo(currentFeed); });
        // All cards refresh
        refreshData.addEventListener('click',()=>generateStationCards(feedSearch.value));
        // Search/filter
        feedSearch.addEventListener('input', function(){
            const val = this.value.trim();
            generateStationCards(val);
            clearSearchBtn.style.display = val.length ? 'inline-block' : 'none';
        });
        clearSearchBtn.addEventListener('click', function(){
            feedSearch.value = '';
            generateStationCards('');
            this.style.display = 'none';
        });
        // Live time update
        setInterval(updateTime, 1000);
        // Init
        updateTime(); getUserLocation(); generateStationCards();
    </script>
</body>
</html>
